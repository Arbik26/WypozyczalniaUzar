@rendermode InteractiveServer
@page "/Films"
@inject MongoDbService MongoService

<link rel="stylesheet" href="css/Films.css" />

<PageTitle>Filmy - Wypo≈ºyczalnia Film√≥w</PageTitle>

<div class="films-container">
    <!-- Nag≈Ç√≥wek -->
    <div class="films-header">
        <h1>üìΩÔ∏è Kolekcja Film√≥w</h1>
        <p>Odkryj i wypo≈ºycz najlepsze filmy</p>
    </div>

    <!-- Sekcja wyszukiwania i filtrowania -->
    <div class="filters-wrapper">
        <div class="search-box">
            <input type="text" 
                   class="search-input" 
                   placeholder="üîç Szukaj po tytule..." 
                   @oninput="@((ChangeEventArgs e) => OnSearchChange(e.Value?.ToString()))" />
        </div>

        <div class="filters-group">
            <select class="filter-select" @onchange="@OnGenreChange">
                <option value="">üé¨ Wszystkie gatunki</option>
                <option value="Science Fiction">Science Fiction</option>
                <option value="Drama">Drama</option>
                <option value="Thriller">Thriller</option>
                <option value="Komedia">Komedia</option>
                <option value="Horror">Horror</option>
                <option value="Akcja">Akcja</option>
            </select>

            <select class="filter-select" @onchange="@OnSortChange">
                <option value="title">Sortuj po tytule ‚Üë</option>
                <option value="rating">Sortuj po ocenie ‚≠ê</option>
                <option value="length">Sortuj po d≈Çugo≈õci ‚è±Ô∏è</option>
            </select>
        </div>
    </div>

    <!-- Zawarto≈õƒá -->
    @if (isLoading)
    {
        <div class="loading">
            <div class="spinner"></div>
            <p>≈Åadowanie film√≥w...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-error">
            <span>‚ùå</span> @errorMessage
        </div>
    }
    else if (filteredMovies != null && filteredMovies.Count > 0)
    {
        <div class="results-info">
            Znalezione <strong>@filteredMovies.Count</strong> film√≥w
        </div>

        <div class="movies-grid">
            @foreach (var movie in filteredMovies)
            {
                <div class="movie-card">
                    <div class="movie-card-top">
                        <div class="rating-badge">‚≠ê @movie.Rating.ToString("F1")</div>
                        <span class="status-badge @(movie.Available ? "available" : "unavailable")">
                            @(movie.Available ? "‚úì" : "‚úó")
                        </span>
                    </div>

                    <h3 class="movie-title">@movie.Title</h3>
                    
                    <div class="movie-meta">
                        <div class="meta-item">
                            <span class="label">Re≈ºyser</span>
                            <span class="value">@movie.Director</span>
                        </div>
                        <div class="meta-item">
                            <span class="label">Gatunek</span>
                            <span class="value">@movie.Genre</span>
                        </div>
                        <div class="meta-item">
                            <span class="label">Czas</span>
                            <span class="value">@movie.Length min</span>
                        </div>
                    </div>

                    <button class="btn-details" @onclick="@(() => OpenDetails(movie))">
                        Szczeg√≥≈Çy
                    </button>
                </div>
            }
        </div>
    }
    else
    {
        <div class="no-movies">
            <span class="no-movies-icon">üé¨</span>
            <p>Brak film√≥w spe≈ÇniajƒÖcych kryteria</p>
        </div>
    }
</div>

<!-- Modal szczeg√≥≈Ç√≥w -->
@if (selectedMovie != null && showModal)
{
    <div class="modal-overlay" @onclick="@CloseDetails">
        <div class="modal-content" @onclick:stopPropagation="true">
            <button class="modal-close" @onclick="@CloseDetails">‚úï</button>
            
            <div class="modal-header">
                <h2>@selectedMovie.Title</h2>
                <div class="modal-rating">‚≠ê @selectedMovie.Rating.ToString("F1")/10</div>
            </div>

            <div class="modal-body">
                <div class="detail-section">
                    <div class="detail-item">
                        <span class="detail-label">Re≈ºyser</span>
                        <span class="detail-value">@selectedMovie.Director</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Gatunek</span>
                        <span class="detail-value">@selectedMovie.Genre</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Czas trwania</span>
                        <span class="detail-value">@selectedMovie.Length minut</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Status</span>
                        <span class="detail-value @(selectedMovie.Available ? "text-available" : "text-unavailable")">
                            @(selectedMovie.Available ? "‚úì Dostƒôpny" : "‚úó Niedostƒôpny")
                        </span>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(selectedMovie.Description))
                {
                    <div class="description-box">
                        <h3>Opis</h3>
                        <p>@selectedMovie.Description</p>
                    </div>
                }

                @if (selectedMovie.Actors != null && selectedMovie.Actors.Count > 0)
                {
                    <div class="actors-box">
                        <h3>Obsada</h3>
                        <div class="actors-list">
                            @foreach (var actor in selectedMovie.Actors)
                            {
                                <span class="actor-tag">@actor</span>
                            }
                        </div>
                    </div>
                }
            </div>

            <button class="btn-close-modal" @onclick="@CloseDetails">Zamknij</button>
        </div>
    </div>
}

@code {
    private List<Movie> movies = new();
    private List<Movie> filteredMovies = new();
    private bool isLoading = true;
    private string errorMessage = "";
    private string searchTerm = "";
    private string selectedGenre = "";
    private string sortBy = "title";
    private Movie selectedMovie = null;
    private bool showModal = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            movies = await MongoService.GetAvailableMoviesAsync();
            ApplyFiltersAndSort();
            isLoading = false;
        }
        catch (Exception ex)
        {
            errorMessage = $"Problem z po≈ÇƒÖczeniem: {ex.Message}";
            isLoading = false;
            Console.WriteLine($"B≈ÇƒÖd Films.razor: {ex}");
        }
    }

    private void OnSearchChange(string value)
    {
        searchTerm = value ?? "";
        ApplyFiltersAndSort();
    }

    private void OnGenreChange(ChangeEventArgs e)
    {
        selectedGenre = e.Value?.ToString() ?? "";
        ApplyFiltersAndSort();
    }

    private void OnSortChange(ChangeEventArgs e)
    {
        sortBy = e.Value?.ToString() ?? "title";
        ApplyFiltersAndSort();
    }

    private void ApplyFiltersAndSort()
    {
        filteredMovies = movies.Where(m => m.Available).ToList();

        if (!string.IsNullOrEmpty(searchTerm))
        {
            filteredMovies = filteredMovies
                .Where(m => m.Title.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }

        if (!string.IsNullOrEmpty(selectedGenre))
        {
            filteredMovies = filteredMovies
                .Where(m => m.Genre.Contains(selectedGenre, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }

        filteredMovies = sortBy switch
        {
            "rating" => filteredMovies.OrderByDescending(m => m.Rating).ToList(),
            "length" => filteredMovies.OrderBy(m => m.Length).ToList(),
            _ => filteredMovies.OrderBy(m => m.Title).ToList()
        };
    }

    private void OpenDetails(Movie movie)
    {
        selectedMovie = movie;
        showModal = true;
    }

    private void CloseDetails()
    {
        showModal = false;
        selectedMovie = null;
    }
}
